import os
import sys
import time
from malware_scanner.core import scan_with_yara
from malware_scanner.virus_total import virustotal_scan
from malware_scanner.metadata_extractor import extract_metadata


def ensure_root():
    """Ensure the program runs as root."""
    if os.name != 'nt':  # Skip for Windows
        if os.geteuid() != 0:
            print("[ERROR] This tool must be run as root or superuser!")
            sys.exit(1)


def menu():
    print("[1] Scan a file with YARA rules")
    print("[2] Scan a file with VirusTotal")
    print("[3] Extract metadata from file (with ExifTool option)")
    print("[4] Exit")

def main():
    ensure_root()

    while True:
        menu()
        choice = input("\nEnter your choice: ").strip()

        if choice == "1":
            file_path = input("Enter file path to scan: ").strip()
            scan_with_yara(file_path)
        elif choice == "2":
            file_path = input("Enter file path to scan via VirusTotal: ").strip()
            api_key = input("Enter your VirusTotal API Key: ").strip()
            virustotal_scan(file_path, api_key)
        elif choice == "3":
            file_path = input("Enter file path to extract metadata: ").strip()
            exif_choice = input("Use ExifTool for metadata extraction? (yes/no/auto): ").strip().lower()
            if exif_choice in ["yes", "y", "true", "1"]:
                extract_metadata(file_path, use_exiftool=True)
            elif exif_choice in ["no", "n", "false", "0"]:
                extract_metadata(file_path, use_exiftool=False)
            else:
                # Auto: try exiftool, fallback to python-magic
                try:
                    extract_metadata(file_path, use_exiftool=True)
                except Exception:
                    extract_metadata(file_path, use_exiftool=False)
        elif choice == "4":
            print("[*] Exiting. Stay safe, hacker!")
            break
        else:
            print("[!] Invalid choice. Try again.")

        time.sleep(1)
