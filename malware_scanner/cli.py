
import os
import sys
import time
from malware_scanner.core import scan_with_yara
from malware_scanner.virus_total import virustotal_scan
from malware_scanner.metadata_extractor import extract_metadata
from malware_scanner.utils import print_result

def ensure_root():
    """Ensure the program runs as root."""
    if os.name != 'nt':  # Skip for Windows
        if os.geteuid() != 0:
            print_result("This tool must be run as root or superuser!", "error")
            sys.exit(1)

def ensure_root():
    """Ensure the program runs as root."""
    if os.name != 'nt':  # Skip for Windows
        if os.geteuid() != 0:
            print_result("This tool must be run as root or superuser!", "error")
            sys.exit(1)

def menu():
    print_result("\n=== malyz3r: Advanced Malware Scanner ===", "info")
    print_result("[1] Scan a file with YARA rules", "info")
    print_result("[2] Scan a file with VirusTotal", "info")
    print_result("[3] Extract metadata from file (with ExifTool option)", "info")
    print_result("[4] Exit", "info")



def main():
    ensure_root()
    while True:
        menu()
        choice = input("\nEnter your choice (1-4): ").strip()

        if choice == "1":
            file_path = input("\n[File Scan] Enter file path: ").strip()
            if not file_path:
                print_result("[File Scan] No file path provided. Please try again.", "error")
                continue
            if not os.path.isfile(file_path):
                print_result(f"[File Scan] File not found: {file_path}", "error")
                continue
            scan_with_yara(file_path)
        elif choice == "2":
            file_path = input("\n[VirusTotal] Enter file path: ").strip()
            if not file_path:
                print_result("[VirusTotal] No file path provided. Please try again.", "error")
                continue
            if not os.path.isfile(file_path):
                print_result(f"[VirusTotal] File not found: {file_path}", "error")
                continue
            api_key = input("[VirusTotal] Enter your VirusTotal API Key: ").strip()
            if not api_key:
                print_result("[VirusTotal] No API key provided. Please try again.", "error")
                continue
            virustotal_scan(file_path, api_key)
        elif choice == "3":
            file_path = input("\n[Metadata] Enter file path: ").strip()
            if not file_path:
                print_result("[Metadata] No file path provided. Please try again.", "error")
                continue
            if not os.path.isfile(file_path):
                print_result(f"[Metadata] File not found: {file_path}", "error")
                continue
            exif_choice = input("[Metadata] Use ExifTool? (yes/no/auto): ").strip().lower()
            if exif_choice in ["yes", "y", "true", "1"]:
                extract_metadata(file_path, use_exiftool=True)
            elif exif_choice in ["no", "n", "false", "0"]:
                extract_metadata(file_path, use_exiftool=False)
            else:
                # Auto: try exiftool, fallback to python-magic
                try:
                    extract_metadata(file_path, use_exiftool=True)
                except Exception:
                    extract_metadata(file_path, use_exiftool=False)
        elif choice == "4":
            print_result("Exiting. Stay safe, hacker!", "success")
            break
        else:
            print_result("Invalid choice. Please enter a number between 1 and 4.", "error")

        time.sleep(0.5)
