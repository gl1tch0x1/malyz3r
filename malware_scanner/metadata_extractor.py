
import os
import magic
import subprocess
from datetime import datetime
from malware_scanner.utils import print_result

def extract_metadata(file_path, use_exiftool=False):
    if not os.path.exists(file_path):
        print_result("File does not exist!", "error")
        return

    if use_exiftool:
        try:
            result = subprocess.run(["exiftool", file_path], capture_output=True, text=True, check=True)
            print_result("[*] ExifTool Metadata:", "info")
            print(result.stdout)
            return
        except FileNotFoundError:
            print_result("ExifTool is not installed or not in PATH. Falling back to internal metadata extraction.", "error")
        except Exception as e:
            print_result(f"ExifTool error: {e}. Falling back to internal metadata extraction.", "error")

    # Fallback to python-magic and os
    file_size = os.path.getsize(file_path)
    created = datetime.fromtimestamp(os.path.getctime(file_path))
    modified = datetime.fromtimestamp(os.path.getmtime(file_path))
    file_type = magic.from_file(file_path)

    print_result("[*] File Metadata:", "info")
    print(f"File Path: {file_path}")
    print(f"File Size: {file_size} bytes")
    print(f"Created: {created}")
    print(f"Modified: {modified}")
    print(f"Type: {file_type}")
