# Advanced YARA Rule: Fileless PowerShell Memory
rule Fileless_PowerShell_Memory
{
    meta:
        description = "Detects fileless PowerShell malware in memory"
        author = "malyz3r"
        last_modified = "2025-09-30"
    strings:
        $ps1 = /powershell\s+-[eE]ncode[dD]\s+[A-Za-z0-9+/=]+/
        $mem = "ReflectiveLoader"
        $injection = "VirtualAllocEx"
    condition:
        any of them
}

rule CobaltStrike_Beacon
{
    meta:
        description = "Detects Cobalt Strike Beacon payloads"
        author = "malyz3r"
        last_modified = "2025-09-30"
    strings:
        $malleable = "Malleable_C2"
        $jitter = "jitter"
        $pipe = "\\\\.\\pipe\\msagent_"
        $dns = "dns_stager"
        $http = "GET /submit.php HTTP/1.1"
    condition:
        2 of them
}

rule Suspicious_Macro_Doc
{
    meta:
        description = "Detects suspicious macros in Office documents"
        author = "malyz3r"
        last_modified = "2025-09-30"
    strings:
        $autoopen = "AutoOpen"
        $shell = "Shell.Application"
        $wscript = "WScript.Shell"
        $powershell = "powershell.exe"
        $base64 = /[A-Za-z0-9+/=]{40,}/
    condition:
        any of them
}

rule Exploit_CVE_2017_11882
{
    meta:
        description = "Detects RTF exploit for CVE-2017-11882"
        author = "malyz3r"
        last_modified = "2025-09-30"
    strings:
        $rtf = "{\rtf"
        $eqnedt = "eqnedt32.exe"
        $objdata = "objdata"
    condition:
        all of them
}

rule Suspicious_PE_Inject
{
    meta:
        description = "Detects suspicious process injection APIs in PE files"
        author = "malyz3r"
        last_modified = "2025-09-30"
    strings:
        $va = "VirtualAllocEx"
        $wpm = "WriteProcessMemory"
        $crt = "CreateRemoteThread"
        $ntm = "NtMapViewOfSection"
    condition:
        2 of them
}
