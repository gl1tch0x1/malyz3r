import os
import sys
import tempfile
from malware_scanner.core import scan_with_yara, hash_file

def test_hash_file():
    # Create a temp file
    with tempfile.NamedTemporaryFile(delete=False) as tf:
        tf.write(b"test1234")
        tf.flush()
        expected = "a906449d5769fa7361d7ecc6aa3f6d28b9eac5b2d06c34338c1a7f1b3e5e5c0b"
        assert hash_file(tf.name) == expected, "SHA256 hash mismatch"
    os.unlink(tf.name)

def test_yara_scan_clean():
    # Should not match any rules
    with tempfile.NamedTemporaryFile(delete=False) as tf:
        tf.write(b"benign sample file")
        tf.flush()
        scan_with_yara(tf.name)
    os.unlink(tf.name)

def test_yara_scan_malicious():
    # Should match a generic rule (e.g., worm, trojan)
    with tempfile.NamedTemporaryFile(delete=False) as tf:
        tf.write(b"cmd.exe /c powershell -nop -w hidden VirtualAllocEx")
        tf.flush()
        scan_with_yara(tf.name)
    os.unlink(tf.name)

def run_all_tests():
    print("Running malyz3r test suite...")
    test_hash_file()
    test_yara_scan_clean()
    test_yara_scan_malicious()
    print("All tests passed!")

if __name__ == "__main__":
    run_all_tests()
